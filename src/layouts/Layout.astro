---
// Import your schema functions
import {
  generateProductSchema,
  generateHomepageSchema,
  generatePageSchema,
} from "../utils/structureData";

const {
  title = "Mdogomdogo Deals Kenya | Lipa Mdogo Mdogo Phones Nairobi, Kiambu & Beyond",
  description = "Buy affordable smartphones on Lipa Mdogo Mdogo in Nairobi and Kiambu. Get Samsung, Infinix, Itel, Tecno, and more with home delivery. Pay slowly, own it easily.",
  canonical = "https://mdogomdogodeals.co.ke",
  ogImage = "https://mdogomdogodeals.co.ke/phones/samsung-a15.png",
  ogType = "website",
  ogLocale = "en_KE",
  twitterCard = "summary_large_image",
  product, // For individual product pages
  products, // For homepage with multiple products
  pageType, // 'product' | 'homepage' | 'other'
  schema, // Optional: pre-generated schema (can be array or string)
  keywords: customKeywords, // Allow custom keywords from parent
  // Product-specific meta tags
  productPrice,
  productCurrency = "KES",
  productAvailability = "in stock",
  productCondition = "new",
  productBrand,
  robots = "index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1",
} = Astro.props;

// Default keywords
const defaultKeywords = [
  "lipa mdogo mdogo phones",
  "simu za kulipa polepole",
  "affordable smartphones",
  "cheap smartphones",
  "get smartphones in nairobi",
  "m-kopa",
  "watu",
  "ulephone",
  "chukua simu lipa polepole",
  "cheap samsung",
  "affordable samsung",
  "hmd phone",
  "mkopa phone",
  "watu phones online",
  "phone online delivery",
  "samsung lipa mdogo mdogo",
  "itel lipa mdogo mdogo",
  "infinix lipa mdogo mdogo",
  "buy phone on credit in kenya",
  "phone lipa polepole",
  "simu kwa malipo polepole",
  "phones for sale in nairobi",
  "budget phones kenya",
  "cheap android phones nairobi",
  "phones with delivery",
  "lipa mdogo mdogo nairobi",
  "kiambu phone offers",
  "installment phones kenya",
];

// Use custom keywords if provided, otherwise use defaults
const keywords = customKeywords || defaultKeywords.join(", ");

// Generate appropriate schema based on page type
let generatedSchema = "";

if (schema) {
  // Handle pre-generated schema (can be string or array of schemas)
  if (Array.isArray(schema)) {
    // If it's an array of schema objects, stringify each and join
    generatedSchema = schema
      .map((s) => (typeof s === "string" ? s : JSON.stringify(s)))
      .join("");
  } else if (typeof schema === "string") {
    // If it's already a string, use it directly
    generatedSchema = schema;
  } else {
    // If it's a single object, stringify it
    generatedSchema = JSON.stringify(schema);
  }
} else if (pageType === "product" && product) {
  // Generate product schema for individual product pages
  generatedSchema = generateProductSchema(product);
} else if (pageType === "homepage" && products) {
  // Generate homepage schema for pages with multiple products
  generatedSchema = generateHomepageSchema(products);
} else if (product) {
  // Fallback: if product exists but no pageType specified
  generatedSchema = generateProductSchema(product);
} else if (products) {
  // Fallback: if products exist but no pageType specified
  generatedSchema = generateHomepageSchema(products);
}

// Parse schema if it's a concatenated string of multiple schemas
let schemaArray = [];
if (generatedSchema) {
  try {
    // Try to split if it looks like concatenated JSON objects
    if (generatedSchema.includes("}{")) {
      // Split by }{ and add back the braces
      const parts = generatedSchema.split("}{").map((part, index, arr) => {
        if (index === 0) return part + "}";
        if (index === arr.length - 1) return "{" + part;
        return "{" + part + "}";
      });
      schemaArray = parts;
    } else {
      schemaArray = [generatedSchema];
    }
  } catch (e) {
    schemaArray = [generatedSchema];
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />

    <!-- Robots -->
    <meta name="robots" content={robots} />

    <!-- Canonical -->
    <link rel="canonical" href={canonical} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:url" content={canonical} />

    <!-- Product-specific Open Graph tags -->
    {
      productPrice && (
        <>
          <meta property="product:price:amount" content={productPrice} />
          <meta property="product:price:currency" content={productCurrency} />
        </>
      )
    }
    {
      productAvailability && (
        <meta property="product:availability" content={productAvailability} />
      )
    }
    {
      productCondition && (
        <meta property="product:condition" content={productCondition} />
      )
    }
    {productBrand && <meta property="product:brand" content={productBrand} />}

    <!-- Twitter Card -->
    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- JSON-LD Structured Data -->
    {
      schemaArray.length > 0 &&
        schemaArray.map((schemaItem) => (
          <script type="application/ld+json" set:html={schemaItem} />
        ))
    }

    <!-- Allow additional head content from child components -->
    <slot name="head" />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />

    <slot name="head" />

    <style>
      :global(html),
      :global(body) {
        margin: 0;
        padding: 0;
        max-width: 100vw;
      }

      html,
      body {
        max-width: 100vw;
        overflow-x: hidden;
        /* background: #fffaf0; */
        background: #fef5e7;
      }

      :global(*) {
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <slot />
  </body>
</html>

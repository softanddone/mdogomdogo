---
import Nav2 from "../components/Nav2.astro";
---

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex, nofollow" />
    <title>Cart</title>
    <style is:global>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        background: #f4f4f4;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica", "Arial", sans-serif;
        color: #333;
      }

      .cart-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .cart-header {
        background: white;
        padding: 20px 24px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .cart-header h2 {
        font-size: 24px;
        font-weight: 500;
        color: #282828;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      #cart-count {
        font-weight: 700;
      }

      .cart-layout {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 20px;
        align-items: start;
      }

      .cart-items-section {
        background: white;
        border-radius: 4px;
        overflow: hidden;
        min-height: 200px;
      }

      .empty-cart {
        text-align: center;
        padding: 80px 20px;
      }

      .empty-cart svg {
        color: #ddd;
        margin-bottom: 20px;
      }

      .empty-cart h3 {
        font-size: 20px;
        font-weight: 500;
        color: #282828;
        margin-bottom: 8px;
      }

      .empty-cart p {
        color: #999;
        font-size: 14px;
      }

      .cart-item {
        display: grid;
        grid-template-columns: 100px 1fr 140px 120px;
        gap: 20px;
        padding: 24px;
        border-bottom: 1px solid #f0f0f0;
        align-items: center;
      }

      .cart-item:last-child {
        border-bottom: none;
      }

      .item-image {
        width: 100px;
        height: 100px;
        background: #fafafa;
        border-radius: 4px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .item-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .item-name {
        font-size: 15px;
        font-weight: 400;
        color: #282828;
        line-height: 1.4;
        margin: 0;
      }

      .item-meta {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .item-price {
        font-size: 16px;
        font-weight: 600;
        color: #282828;
      }

      .item-actions-mobile {
        display: none;
      }

      .remove-btn-text {
        background: none;
        border: none;
        color: #f68b1e;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        padding: 4px 0;
        text-decoration: underline;
      }

      .remove-btn-text:hover {
        color: #e57a0e;
      }

      .item-quantity {
        display: flex;
        align-items: center;
      }

      .quantity-control {
        display: flex;
        align-items: center;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        background: white;
      }

      .qty-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
        transition: background 0.2s;
        padding: 0;
      }

      .qty-btn:hover {
        background: #f8f8f8;
      }

      .qty-btn:active {
        background: #eee;
      }

      .qty-btn svg {
        pointer-events: none;
      }

      .qty-value {
        width: 50px;
        height: 36px;
        border: none;
        border-left: 1px solid #e0e0e0;
        border-right: 1px solid #e0e0e0;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
        color: #282828;
        background: white;
        outline: none;
      }

      .item-total {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 12px;
      }

      .total-price {
        font-size: 18px;
        font-weight: 700;
        color: #282828;
        margin: 0;
      }

      .remove-btn {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 8px;
        transition: color 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-btn:hover {
        color: #e74c3c;
      }

      .remove-btn svg {
        pointer-events: none;
      }

      .cart-summary-section {
        position: sticky;
        top: 20px;
      }

      .summary-card {
        background: white;
        border-radius: 4px;
        padding: 24px;
      }

      .summary-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #282828;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 20px;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        font-size: 14px;
        color: #666;
      }

      .summary-value {
        font-weight: 600;
        color: #282828;
      }

      .summary-divider {
        height: 1px;
        background: #f0f0f0;
        margin: 12px 0;
      }

      .total-row {
        font-size: 16px;
        font-weight: 600;
        color: #282828;
        padding: 16px 0;
      }

      .total-value {
        font-size: 20px;
        font-weight: 700;
        color: #f68b1e;
      }

      #checkout-btn {
        width: 100%;
        background: #f68b1e;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.3s;
      }

      #checkout-btn:hover {
        background: #e57a0e;
      }

      #checkout-btn:active {
        background: #d4700d;
      }

      @media (max-width: 1024px) {
        .cart-layout {
          grid-template-columns: 1fr;
        }

        .cart-summary-section {
          position: static;
        }
      }

      @media (max-width: 768px) {
        .cart-page {
          padding: 12px;
        }

        .cart-header {
          padding: 16px;
          margin-bottom: 12px;
        }

        .cart-header h2 {
          font-size: 18px;
        }

        .cart-item {
          grid-template-columns: 80px 1fr;
          grid-template-rows: auto auto;
          gap: 12px 16px;
          padding: 16px;
        }

        .item-image {
          width: 80px;
          height: 80px;
          grid-row: 1 / 3;
        }

        .item-details {
          grid-column: 2;
          grid-row: 1;
        }

        .item-actions-mobile {
          display: block;
          margin-top: 8px;
        }

        .item-quantity {
          grid-column: 2;
          grid-row: 2;
          justify-content: flex-start;
        }

        .item-total {
          display: none;
        }

        .item-name {
          font-size: 14px;
        }

        .item-price {
          font-size: 15px;
        }

        .quantity-control {
          width: 120px;
        }

        .summary-card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <main class="cart-page">
      <Nav2 />
      <div class="cart-header">
        <h2>Cart (<span id="cart-count">0</span>)</h2>
      </div>

      <div class="cart-layout">
        <div class="cart-items-section">
          <div id="cart-container"></div>
        </div>

        <div class="cart-summary-section">
          <div class="summary-card">
            <h3>CART SUMMARY</h3>
            <div class="summary-row">
              <span>Subtotal</span>
              <span class="summary-value"
                >KSh <span id="cart-total">0</span></span
              >
            </div>
            <div class="summary-divider"></div>
            <div class="summary-row total-row">
              <span>Total</span>
              <span class="summary-value total-value"
                >KSh <span id="cart-total-final">0</span></span
              >
            </div>
            <button id="checkout-btn"
              >CHECKOUT (KSh <span id="checkout-amount">0</span>)</button
            >
          </div>
        </div>
      </div>
    </main>

    <script>
      // run after DOM ready
      document.addEventListener("DOMContentLoaded", () => {
        // make functions global so inline onclick handlers can call them
        window.renderCart = function renderCart() {
          const cartContainer = document.getElementById("cart-container");
          const cart = JSON.parse(localStorage.getItem("cart") || "[]");

          // Update cart count
          document.getElementById("cart-count").textContent = cart.length;

          if (!cart.length) {
            cartContainer.innerHTML = `
              <div class="empty-cart">
                <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="9" cy="21" r="1"/>
                  <circle cx="20" cy="21" r="1"/>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                </svg>
                <h3>Your cart is empty!</h3>
                <p>Browse our products and add items to your cart.</p>
              </div>`;
            document.getElementById("cart-total").textContent = "0";
            document.getElementById("cart-total-final").textContent = "0";
            document.getElementById("checkout-amount").textContent = "0";
            return;
          }

          let html = "";
          let total = 0;

          // build UI using product id for actions
          cart.forEach((item) => {
            // Convert price string "KSh 3,500" to number
            const price =
              typeof item.price === "string"
                ? parseFloat(item.price.replace(/[^\d.]/g, ""))
                : item.price;
            const itemTotal = price * item.quantity;
            total += itemTotal;
            console.log("prixe" + item.price);
            html += `
              <div class="cart-item" data-id="${item.id}">
                <div class="item-image">
                  <img src="${item.img}" alt="${item.name}" />
                </div>
                <div class="item-details">
                  <h4 class="item-name">${item.name}</h4>
                  <div class="item-meta">
                    <span class="item-price">KSh ${price.toLocaleString()}</span>
                  </div>
                  <div class="item-actions-mobile">
                    <button class="remove-btn-text" data-id="${item.id}">REMOVE</button>
                  </div>
                </div>
                <div class="item-quantity">
                  <div class="quantity-control">
                    <button class="qty-btn qty-decrease" data-action="decrease" data-id="${item.id}">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </button>
                    <input type="text" class="qty-value" value="${item.quantity}" readonly />
                    <button class="qty-btn qty-increase" data-action="increase" data-id="${item.id}">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="item-total">
                  <p class="total-price">KSh ${itemTotal.toLocaleString()}</p>
                  <button class="remove-btn" data-id="${item.id}">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </div>
              </div>`;
          });

          cartContainer.innerHTML = html;
          document.getElementById("cart-total").textContent =
            total.toLocaleString();
          document.getElementById("cart-total-final").textContent =
            total.toLocaleString();
          document.getElementById("checkout-amount").textContent =
            total.toLocaleString();

          // attach delegated listeners (safer than inline onclick)
          // quantity buttons
          cartContainer.querySelectorAll(".qty-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const id = btn.dataset.id;
              const action = btn.dataset.action;
              if (action === "increase") window.changeQuantity(id, 1);
              else window.changeQuantity(id, -1);
            });
          });

          // remove buttons (both desktop and mobile)
          cartContainer
            .querySelectorAll(".remove-btn, .remove-btn-text")
            .forEach((btn) => {
              btn.addEventListener("click", () => {
                window.removeItem(btn.dataset.id);
              });
            });
        };

        // change quantity by product id
        window.changeQuantity = function changeQuantity(id, delta) {
          try {
            let cart = JSON.parse(localStorage.getItem("cart") || "[]");
            const idx = cart.findIndex((it) => String(it.id) === String(id));
            if (idx === -1) return;
            cart[idx].quantity = (cart[idx].quantity || 1) + delta;
            if (cart[idx].quantity < 1) cart[idx].quantity = 1;
            localStorage.setItem("cart", JSON.stringify(cart));
            window.renderCart();
            window.dispatchEvent(new Event("cartUpdated"));
          } catch (err) {
            console.error("changeQuantity error:", err);
          }
        };

        // remove by product id
        window.removeItem = function removeItem(id) {
          try {
            let cart = JSON.parse(localStorage.getItem("cart") || "[]");
            cart = cart.filter((it) => String(it.id) !== String(id));
            localStorage.setItem("cart", JSON.stringify(cart));
            window.renderCart();
            window.dispatchEvent(new Event("cartUpdated"));
          } catch (err) {
            console.error("removeItem error:", err);
          }
        };

        // checkout (clears cart)
        const checkoutBtn = document.getElementById("checkout-btn");

        checkoutBtn.addEventListener("click", () => {
          // redirect to WhatsApp
          window.location.href =
            "https://wa.me/254762790513?text=Hello%2C%20I'm%20interested%20in%20your%20products";

          // optional: clear cart after redirect
          localStorage.removeItem("cart");
          window.renderCart();
          window.dispatchEvent(new Event("cartUpdated"));
        });

        // initial render
        window.renderCart();
      });
    </script>
  </body>
</html>

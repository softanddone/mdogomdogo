<script>
  import { products } from "../../data/product2";

  interface Product {
    id: number;
    name: string;
    status: string;
    image: string;
    from: string;
    totalPrice: string;
    slug: string;
    source: string;
    deposit: string;
  }

  function updateCartCount() {
    try {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const count = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
      const el = document.getElementById("cart-count");
      if (el) el.textContent = count;
    } catch (err) {
      console.error("updateCartCount error:", err);
    }
  }

  updateCartCount();
  window.addEventListener("cartUpdated", updateCartCount);
  window.addEventListener("storage", (ev) => {
    if (ev.key === "cart") updateCartCount();
  });

  class FakePlaceholderRotator {
    private elements: Array<{
      input: HTMLInputElement;
      fakePlaceholder: HTMLElement;
    }> = [];
    private placeholders: string[] = [
      "Search phones on credit...",
      "Buy phone on credit",
      "Choose the best phone..",
    ];
    private currentIndex: number = 0;
    private interval: number = 3000;
    private timer: number | null = null;

    constructor(configs: Array<{ inputId: string; placeholderId: string }>) {
      this.init(configs);
    }

    private init(
      configs: Array<{ inputId: string; placeholderId: string }>
    ): void {
      configs.forEach((config) => {
        const input = document.getElementById(
          config.inputId
        ) as HTMLInputElement | null;
        const fakePlaceholder = document.getElementById(
          config.placeholderId
        ) as HTMLElement | null;

        if (input && fakePlaceholder) {
          this.elements.push({ input, fakePlaceholder });
          fakePlaceholder.textContent = this.placeholders[0];
          input.addEventListener("focus", () => this.pause());
          input.addEventListener("blur", () => this.startRotation());
        }
      });

      if (this.elements.length === 0) return;
      this.startRotation();
    }

    private setPlaceholder(index: number): void {
      const text = this.placeholders[index];
      const animationIndex = (index % 3) + 1;

      this.elements.forEach(({ input, fakePlaceholder }) => {
        if (document.activeElement !== input && input.value === "") {
          fakePlaceholder.classList.remove(
            "animation-1-in",
            "animation-1-out",
            "animation-2-in",
            "animation-2-out",
            "animation-3-in",
            "animation-3-out"
          );

          fakePlaceholder.classList.add(`animation-${animationIndex}-out`);

          const outDuration =
            animationIndex === 1 ? 500 : animationIndex === 2 ? 400 : 500;

          setTimeout(() => {
            fakePlaceholder.textContent = text;
            fakePlaceholder.classList.remove(`animation-${animationIndex}-out`);
            fakePlaceholder.classList.add(`animation-${animationIndex}-in`);

            const inDuration =
              animationIndex === 1 ? 700 : animationIndex === 2 ? 700 : 800;
            setTimeout(() => {
              fakePlaceholder.classList.remove(
                `animation-${animationIndex}-in`
              );
            }, inDuration);
          }, outDuration);
        }
      });
    }

    private next(): void {
      this.currentIndex = (this.currentIndex + 1) % this.placeholders.length;
      this.setPlaceholder(this.currentIndex);
    }

    private startRotation(): void {
      this.pause();
      this.timer = window.setInterval(() => this.next(), this.interval);
    }

    private pause(): void {
      if (this.timer !== null) {
        clearInterval(this.timer);
        this.timer = null;
      }
    }
  }

  const menuBtn = document.getElementById(
    "menuBtn"
  ) as HTMLButtonElement | null;
  const mobileMenu = document.getElementById(
    "mobileMenu"
  ) as HTMLDivElement | null;
  const closeBtn = document.getElementById(
    "closeBtn"
  ) as HTMLButtonElement | null;

  const searchInput = document.getElementById(
    "searchInput"
  ) as HTMLInputElement | null;
  const searchBtn = document.getElementById(
    "searchBtn"
  ) as HTMLButtonElement | null;
  const searchResults = document.getElementById(
    "searchResults"
  ) as HTMLDivElement | null;

  const searchInputMobile = document.getElementById(
    "searchInputMobile"
  ) as HTMLInputElement | null;
  const searchBtnMobile = document.getElementById(
    "searchBtnMobile"
  ) as HTMLButtonElement | null;
  const searchResultsMobile = document.getElementById(
    "searchResultsMobile"
  ) as HTMLDivElement | null;

  const cartBtn = document.getElementById(
    "cartBtn"
  ) as HTMLButtonElement | null;

  menuBtn?.addEventListener("click", () => {
    const isActive = mobileMenu?.classList.toggle("active");
    menuBtn?.setAttribute("aria-expanded", String(isActive));
    mobileMenu?.setAttribute("aria-hidden", String(!isActive));
  });

  closeBtn?.addEventListener("click", () => {
    mobileMenu?.classList.remove("active");
    menuBtn?.setAttribute("aria-expanded", "false");
    mobileMenu?.setAttribute("aria-hidden", "true");
  });

  document.addEventListener("click", (e: MouseEvent) => {
    const target = e.target as Node;
    if (
      mobileMenu?.classList.contains("active") &&
      !mobileMenu.contains(target) &&
      menuBtn &&
      !menuBtn.contains(target)
    ) {
      mobileMenu.classList.remove("active");
      menuBtn?.setAttribute("aria-expanded", "false");
      mobileMenu?.setAttribute("aria-hidden", "true");
    }
  });

  function performSearch(
    query: string,
    resultsContainer: HTMLDivElement
  ): void {
    if (!query.trim()) {
      resultsContainer.classList.remove("active");
      return;
    }

    const filtered = (products as Product[]).filter((product: Product) =>
      product.name.toLowerCase().includes(query.toLowerCase())
    );

    if (filtered.length === 0) {
      resultsContainer.innerHTML =
        '<div class="no-results" role="status">No products found</div>';
      resultsContainer.classList.add("active");
      return;
    }

    const html: string = filtered
      .map(
        (product: Product) => `
          <a href="/${product.slug}" class="search-result-item" role="option">
            <div class="search-result-image-wrapper">
              <img src="${product.source}" alt="${product.name}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23f3f4f6%22 width=%2260%22 height=%2260%22/%3E%3C/svg%3E'">
            </div>
            <div class="search-result-info">
              <div class="search-result-name">
                ${product.name}
                <span class="search-result-status">${product.status}</span>
              </div>
              <div class="search-result-price">${product.deposit}</div>
            </div>
          </a>
        `
      )
      .join("");

    resultsContainer.innerHTML = html;
    resultsContainer.classList.add("active");
  }

  searchInput?.addEventListener("input", (e: Event) => {
    const target = e.target as HTMLInputElement;
    if (searchResults) {
      performSearch(target.value, searchResults);
    }
  });

  searchBtn?.addEventListener("click", () => {
    if (searchInput && searchResults) {
      performSearch(searchInput.value, searchResults);
    }
  });

  searchInput?.addEventListener("keypress", (e: KeyboardEvent) => {
    if (e.key === "Enter" && searchResults) {
      performSearch(searchInput.value, searchResults);
    }
  });

  searchInputMobile?.addEventListener("input", (e: Event) => {
    const target = e.target as HTMLInputElement;
    if (searchResultsMobile) {
      performSearch(target.value, searchResultsMobile);
    }
  });

  searchBtnMobile?.addEventListener("click", () => {
    if (searchInputMobile && searchResultsMobile) {
      performSearch(searchInputMobile.value, searchResultsMobile);
    }
  });

  searchInputMobile?.addEventListener("keypress", (e: KeyboardEvent) => {
    if (e.key === "Enter" && searchInputMobile && searchResultsMobile) {
      performSearch(searchInputMobile.value, searchResultsMobile);
    }
  });

  document.addEventListener("click", (e: MouseEvent) => {
    const target = e.target as HTMLElement;
    if (!target.closest(".search-container")) {
      searchResults?.classList.remove("active");
      searchResultsMobile?.classList.remove("active");
    }
  });

  function setupKeyboardNavigation(
    input: HTMLInputElement,
    resultsContainer: HTMLDivElement
  ): void {
    input.addEventListener("keydown", (e: KeyboardEvent) => {
      const items = resultsContainer.querySelectorAll(".search-result-item");
      const activeElement = document.activeElement;
      const currentIndex = Array.from(items).indexOf(activeElement as Element);

      if (e.key === "ArrowDown") {
        e.preventDefault();
        if (currentIndex < items.length - 1) {
          (items[currentIndex + 1] as HTMLElement).focus();
        } else if (currentIndex === -1 && items.length > 0) {
          (items[0] as HTMLElement).focus();
        }
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        if (currentIndex > 0) {
          (items[currentIndex - 1] as HTMLElement).focus();
        } else if (currentIndex === 0) {
          input.focus();
        }
      } else if (e.key === "Escape") {
        resultsContainer.classList.remove("active");
        input.value = "";
      }
    });
  }

  if (searchInput && searchResults) {
    setupKeyboardNavigation(searchInput, searchResults);
  }
  if (searchInputMobile && searchResultsMobile) {
    setupKeyboardNavigation(searchInputMobile, searchResultsMobile);
  }

  document.addEventListener("keydown", (e: KeyboardEvent) => {
    if (e.key === "Escape" && mobileMenu?.classList.contains("active")) {
      mobileMenu.classList.remove("active");
      menuBtn?.setAttribute("aria-expanded", "false");
      mobileMenu?.setAttribute("aria-hidden", "true");
      menuBtn?.focus();
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    new FakePlaceholderRotator([
      { inputId: "searchInput", placeholderId: "fakePlaceholder" },
      { inputId: "searchInputMobile", placeholderId: "fakePlaceholderMobile" },
    ]);
  });
</script>

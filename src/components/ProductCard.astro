---
const {
  name,
  image,
  source,
  from,
  deposit,
  totalPrice,
  discount,
  display,
  slug,
  slugs,
  index,
  id,
} = Astro.props;
---

<style>
  :root {
    /* Streamlined design tokens */
    --primary: #ff6b35;
    --primary-hover: #e55a2b;
    --secondary: #2563eb;
    --success: #10b981;
    --error: #ef4444;
    --warning: #f59e0b;

    /* Semantic colors with WCAG AA compliance */
    --bg-primary: #ffffff;
    --bg-secondary: #f8fafc;
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #475569;
    --border: #e2e8f0;
    --border-focus: #cbd5e1;

    /* Spacing system (consistent rem units) */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-6: 1.5rem;
    --space-8: 2rem;

    /* Typography */
    --font-sm: 0.875rem;
    --font-base: 0.9375rem;
    --font-lg: 1rem;
    --font-xl: 1.125rem;
    --font-2xl: 1.25rem;
    --font-medium: 500;
    --font-semibold: 600;
    --font-bold: 700;

    /* Border radius */
    --radius: 0.75rem;
    --radius-lg: 1rem;
    --radius-xl: 1.5rem;

    /* Shadows with consistent opacity */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);

    /* Transitions */
    --transition: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-transform: transform var(--transition);
  }

  /* Component-scoped reset */
  .product-card *,
  .product-card *::before,
  .product-card *::after {
    box-sizing: border-box;
  }

  /* ✅ CRITICAL FIX: Main card container */
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
    /* ✅ REMOVED fixed width - let grid control this */
    width: 100%;
    max-width: 100%;
    min-width: 0; /* Critical for CSS Grid */
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow);
    transition: var(--transition);
    cursor: pointer;
    will-change: transform;
    contain: layout;
  }

  h2 {
    font-family:
      "Inter",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      Roboto,
      sans-serif;
  }

  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: wheat;
  }

  /* ✅ Image container with aspect ratio */
  .product-image {
    position: relative;
    aspect-ratio: 1;
    height: 200px;
    width: 100%; /* Ensure it respects card width */
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(
      135deg,
      var(--bg-secondary) 0%,
      var(--bg-primary) 100%
    );
    border-bottom: 1px solid var(--border);
    overflow: hidden;
    transition: var(--transition-transform);
  }

  .product-card:hover .product-image {
    transform: scale(1.02);
  }

  .product-image img {
    width: 140px;
    height: 140px;
    max-width: 90%; /* Prevent image from breaking bounds */
    object-fit: contain;
    transition: var(--transition-transform);
    image-rendering: auto;
  }

  .product-card:hover .product-image img {
    transform: scale(1.05);
  }

  /* ✅ CRITICAL FIX: Badges with max-width */
  .badge {
    position: absolute;
    top: var(--space-3);
    padding: var(--space-2) var(--space-3);
    font-size: 0.75rem;
    font-weight: var(--font-bold);
    color: white;
    border-radius: var(--radius);
    z-index: 10;
    letter-spacing: 0.025em;
    text-transform: uppercase;
    backdrop-filter: blur(8px);
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 2px 4px rgb(0 0 0 / 0.2);
    /* ✅ Prevent badges from pushing beyond card width */
    max-width: calc(100% - var(--space-6));
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  @keyframes slideIn {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .discount-badge {
    background: rgb(1, 51, 1);
    left: 2px;
  }

  .hot-badge {
    background: #92400e;
    top: 60px !important;
    left: 2px;
  }

  /* ✅ Content area */
  .product-info {
    padding: var(--space-4);
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    width: 100%;
    min-width: 0; /* Allow content to shrink */
  }

  /* ✅ CRITICAL FIX: Typography with text wrapping */
  .product-title {
    margin: 0;
    font-size: var(--font-lg);
    font-weight: var(--font-semibold);
    color: var(--text-primary);
    line-height: 1.4;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    /* ✅ Ensure text wraps instead of overflowing */
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
  }

  .product-title a {
    color: inherit;
    text-decoration: none;
    border-radius: var(--radius);
    padding: var(--space-1);
    margin: calc(-1 * var(--space-1));
    transition: var(--transition);
    position: relative;
    display: block;
    /* ✅ REMOVED: overflow: hidden and text-overflow: ellipsis */
    /* ✅ REMOVED: white-space: nowrap - this was causing overflow! */
    /* Allow text to wrap naturally */
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }

  .product-title a::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: var(--space-1);
    right: var(--space-1);
    height: 2px;
    background: var(--primary);
    transform: scaleX(0);
    transition: var(--transition);
  }

  .product-title a:hover {
    color: var(--secondary);
  }

  .product-title a:hover::after {
    transform: scaleX(1);
  }

  .product-title a:focus-visible {
    outline: 2px solid var(--secondary);
    outline-offset: 2px;
  }

  /* ✅ Pricing section */
  .product-pricing {
    display: flex;
    align-items: baseline;
    gap: var(--space-2);
    flex-wrap: wrap; /* Allow wrapping on very narrow screens */
  }

  .deposit-price {
    font-size: var(--font-sm);
    font-weight: var(--font-bold);
    color: #b91c1c;
    letter-spacing: -0.02em;
    font-family:
      "Inter",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      Roboto,
      sans-serif;
    word-break: break-word; /* Prevent long prices from overflowing */
  }

  .original-price {
    font-size: var(--font-sm);
    color: var(--text-muted);
    text-decoration: line-through;
    font-weight: var(--font-medium);
    word-break: break-word;
  }

  /* Stock status */
  .stock-status {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-sm);
    color: #047857;
    font-weight: var(--font-medium);
    background: rgb(16 185 129 / 0.15);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius);
    width: fit-content;
    max-width: 100%; /* Prevent overflow */
    border: 1px solid rgb(16 185 129 / 0.3);
  }

  .stock-status span {
    font-family:
      "Inter",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      Roboto,
      sans-serif;
  }

  .stock-indicator {
    width: 8px;
    height: 8px;
    flex-shrink: 0; /* Prevent indicator from shrinking */
    border-radius: 50%;
    background: #047857;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }

  /* ✅ Action buttons */
  .product-actions {
    display: flex;
    gap: var(--space-2);
    margin-top: auto;
    width: 100%;
  }

  .btn {
    border: none;
    border-radius: var(--radius-lg);
    font-weight: var(--font-semibold);
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    position: relative;
    overflow: hidden;
    font-family:
      "Inter",
      -apple-system,
      BlinkMacSystemFont,
      "Segoe UI",
      Roboto,
      sans-serif;
    /* ✅ Ensure buttons respect container width */
    max-width: 100%;
  }

  .btn::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      transparent,
      rgb(255 255 255 / 0.2),
      transparent
    );
    transform: translateX(-100%);
    transition: var(--transition);
  }

  .btn:hover::before {
    transform: translateX(100%);
  }

  .btn-primary {
    flex: 1;
    background: var(--primary);
    color: white;
    padding: var(--space-2) var(--space-3);
    font-size: var(--font-base);
    min-height: 40px;
    /* ✅ Prevent button text from overflowing */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
  }

  .btn-secondary {
    width: 44px;
    height: 44px;
    background: var(--bg-primary);
    border: 1px solid var(--border-focus);
    color: var(--text-secondary);
    flex-shrink: 0;
  }

  .btn-secondary:hover {
    background: rgb(255 107 53 / 0.1);
    border-color: var(--primary);
    color: var(--primary);
    transform: scale(1.05);
  }

  .btn:focus-visible {
    outline: 2px solid var(--secondary);
    outline-offset: 2px;
  }

  /* Accessibility improvements */
  .visually-hidden {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }

  /* ✅ Responsive design */
  @media (max-width: 768px) {
    .product-card {
      /* ✅ REMOVED fixed width and max-width */
      width: 100%;
      max-width: 100%;
    }

    .original-price {
      display: none;
    }

    .product-image {
      height: 180px;
    }

    .product-image img {
      width: 120px;
      height: 120px;
    }

    .product-info {
      padding: var(--space-3);
    }

    .product-title {
      font-size: var(--font-base);
    }

    .deposit-price {
      font-size: var(--font-base);
    }
  }

  /* Reduce motion for accessibility */
  @media (prefers-reduced-motion: reduce) {
    .product-card,
    .product-image,
    .product-image img,
    .btn,
    .badge {
      transition: none;
      animation: none;
    }

    .product-card:hover,
    .product-card:hover .product-image,
    .product-card:hover .product-image img,
    .btn:hover,
    .btn-secondary:hover {
      transform: none;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .product-card,
    .btn,
    .stock-status,
    .badge {
      border-width: 2px;
    }

    .deposit-price {
      color: #991b1b;
    }

    .stock-status {
      color: #065f46;
      background: rgb(16 185 129 / 0.25);
      border-color: rgb(16 185 129 / 0.5);
    }

    .stock-indicator {
      background: #065f46;
    }

    .badge {
      text-shadow: 0 1px 2px rgb(0 0 0 / 0.8);
    }

    .discount-badge {
      background: #991b1b;
    }

    .hot-badge {
      background: #78350f;
    }
  }

  /* Print styles */
  @media print {
    .product-card {
      break-inside: avoid;
      box-shadow: none;
      border: 1px solid var(--border);
    }
    .product-actions {
      display: none;
    }
    .badge {
      background: var(--text-primary) !important;
      color: var(--bg-primary) !important;
    }
  }
</style>

<article class="product-card">
  <a
    href={`/${slug}`}
    class="product-image"
    aria-label={`View ${name} details`}
  >
    {
      discount && (
        <span class="badge discount-badge" aria-label={`${discount} discount`}>
          {discount}
        </span>
      )
    }
    {
      display !== "none" && (
        <span
          class="badge hot-badge"
          aria-label="Popular item"
          style={`display: ${display};`}
        >
          Hot
        </span>
      )
    }
    <img
      src={source}
      alt={`${name} product`}
      width="140"
      height="140"
      itemprop="image"
      loading={index === 0 ? "eager" : "lazy"}
      decoding={index === 0 ? "sync" : "async"}
      fetchpriority={index === 0 ? "high" : undefined}
    />
  </a>

  <div class="product-info">
    <h2 class="product-title" itemprop="name">
      <a href={`/${slug}`} aria-describedby={`price-${slug}`}>
        {name}
      </a>
    </h2>

    <div class="product-pricing" id={`price-${slug}`}>
      <span class="deposit-price">
        <span class="visually-hidden">Deposit amount:</span>
        Deposit {deposit}
      </span>
      {
        totalPrice && totalPrice !== deposit && (
          <span class="original-price">
            <span class="visually-hidden">Original price:</span>
            {from}
          </span>
        )
      }
    </div>

    <div class="stock-status" role="status" aria-live="polite">
      <div class="stock-indicator" aria-hidden="true"></div>
      <span>In Stock</span>
    </div>

    <div class="product-actions">
      <a
        href={`/${slug}`}
        class="btn btn-primary add-to-cart"
        aria-label={`Order ${name} with ${deposit} deposit`}
        data-id={id}
        data-name={name}
        data-price={deposit}
        data-img={source}
        onclick="addToCart(this)"
      >
        Order Now
      </a>

      <button
        class="btn btn-secondary add-to-cart"
        type="button"
        aria-label={`Add ${name} to cart`}
        title="Add to cart"
        data-id={id}
        data-name={name}
        data-deposit={deposit}
        data-price={deposit}
        data-img={source}
        onclick="addToCart(this)"
      >
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          aria-hidden="true"
        >
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="m1 1 4 4 10 0 2 11-14 0"></path>
        </svg>
        <span class="visually-hidden">Add to cart</span>
      </button>
    </div>
  </div>
</article>

<script>
  // Add a single modal in the DOM if not exists
  if (!document.getElementById("cart-modal")) {
    const modal = document.createElement("div");
    modal.id = "cart-modal";
    modal.style.cssText =
      "position:fixed;bottom:20px;right:20px;background:#000;color:#fff;padding:10px 15px;border-radius:8px;opacity:0;transition:opacity .3s ease;z-index:9999;";
    document.body.appendChild(modal);
  }

  function showModal(message) {
    const modal = document.getElementById("cart-modal");
    modal.textContent = message;
    modal.style.opacity = "1";
    setTimeout(() => (modal.style.opacity = "0"), 2000);
  }

  if (!window.addToCart) {
    window.addToCart = function (btn) {
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      const price = parseFloat(btn.dataset.price?.replace(/[^\d.]/g, "") || 0);
      const img = btn.dataset.img;

      let cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const existing = cart.find((item) => item.id == id);

      if (existing) {
        showModal(`${name} already in cart`);
        return;
      }

      cart.push({ id, name, price, img, quantity: 1 });
      localStorage.setItem("cart", JSON.stringify(cart));
      window.dispatchEvent(new Event("cartUpdated"));
      showModal(`${name} added to cart`);
    };
  }
</script>
